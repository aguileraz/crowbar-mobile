# Dockerfile for Test Runner
FROM node:18

# Install system dependencies
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    git \
    build-essential \
    python3 \
    python3-pip \
    imagemagick \
    graphicsmagick \
    && rm -rf /var/lib/apt/lists/*

# Install Android SDK platform tools (for ADB)
ENV ANDROID_HOME=/opt/android-sdk
ENV PATH=$PATH:$ANDROID_HOME/platform-tools

RUN mkdir -p $ANDROID_HOME && \
    wget -q https://dl.google.com/android/repository/platform-tools-latest-linux.zip && \
    unzip -q platform-tools-latest-linux.zip -d $ANDROID_HOME && \
    rm platform-tools-latest-linux.zip

# Create working directory
WORKDIR /workspace

# Install test dependencies globally
RUN npm install -g \
    @wdio/cli \
    @wdio/local-runner \
    @wdio/mocha-framework \
    @wdio/spec-reporter \
    @wdio/allure-reporter \
    @percy/cli \
    @percy/appium-app \
    jest \
    jest-html-reporter \
    allure-commandline

# Copy test configuration template
COPY --chmod=644 <<EOF /workspace/wdio.docker.conf.js
exports.config = {
    runner: 'local',
    port: 4723,
    hostname: process.env.APPIUM_HOST || 'appium-server',
    path: '/',
    
    specs: [
        '/tests/specs/**/*.js'
    ],
    
    exclude: [],
    
    maxInstances: 3,
    
    capabilities: [{
        platformName: 'Android',
        'appium:deviceName': 'Android Emulator',
        'appium:platformVersion': process.env.ANDROID_VERSION || '12',
        'appium:automationName': 'UiAutomator2',
        'appium:app': process.env.TEST_APK_PATH || '/apk/debug/app-debug.apk',
        'appium:noReset': false,
        'appium:fullReset': false,
        'appium:newCommandTimeout': 240
    }],
    
    logLevel: 'info',
    bail: 0,
    baseUrl: 'http://localhost',
    waitforTimeout: 10000,
    connectionRetryTimeout: 120000,
    connectionRetryCount: 3,
    
    services: [],
    
    framework: 'mocha',
    
    reporters: ['spec', 
        ['allure', {
            outputDir: '/results/allure-results',
            disableWebdriverStepsReporting: false,
            disableWebdriverScreenshotsReporting: false,
        }]
    ],
    
    mochaOpts: {
        ui: 'bdd',
        timeout: 60000
    },
    
    beforeSession: function (config, capabilities, specs) {
        console.log('Starting test session for:', capabilities.deviceName);
    },
    
    afterSession: function (config, capabilities, specs) {
        console.log('Test session completed');
    }
};
EOF

# Copy test execution script
COPY --chmod=755 <<EOF /workspace/run-tests.sh
#!/bin/bash
set -e

echo "üöÄ Docker Android Test Runner"
echo "============================="

# Configuration
TEST_MODE=\${TEST_MODE:-sequential}
API_LEVELS=\${API_LEVELS:-21,26,31}
RESULTS_DIR=/results

# Function to wait for emulator
wait_for_emulator() {
    local port=\$1
    local api_level=\$2
    local max_attempts=60
    local attempt=0
    
    echo "‚è≥ Waiting for emulator API \$api_level on port \$port..."
    
    while [ \$attempt -lt \$max_attempts ]; do
        if adb connect host.docker.internal:\$port 2>/dev/null; then
            if adb -s host.docker.internal:\$port shell getprop sys.boot_completed 2>/dev/null | grep -q "1"; then
                echo "‚úÖ Emulator API \$api_level is ready!"
                return 0
            fi
        fi
        
        attempt=\$((attempt + 1))
        echo -n "."
        sleep 5
    done
    
    echo "‚ùå Timeout waiting for emulator API \$api_level"
    return 1
}

# Function to install APK
install_apk() {
    local port=\$1
    local apk_path=\$2
    
    echo "üì± Installing APK on emulator port \$port..."
    adb -s host.docker.internal:\$port install -r \$apk_path
}

# Function to run tests
run_test_suite() {
    local api_level=\$1
    local port=\$2
    
    echo ""
    echo "üß™ Running tests for API Level \$api_level"
    echo "----------------------------------------"
    
    # Set environment variables for this test run
    export ANDROID_VERSION=\$api_level
    export DEVICE_PORT=\$port
    export RESULTS_PATH=\$RESULTS_DIR/api-\$api_level
    
    # Create results directory
    mkdir -p \$RESULTS_PATH
    
    # Run WebDriverIO tests
    npx wdio /workspace/wdio.docker.conf.js
    
    # Generate Allure report
    allure generate \$RESULTS_PATH/allure-results -o \$RESULTS_PATH/allure-report --clean
    
    echo "‚úÖ Tests completed for API Level \$api_level"
}

# Function to run visual regression tests
run_visual_tests() {
    local api_level=\$1
    
    echo ""
    echo "üëÅÔ∏è Running visual regression tests for API Level \$api_level"
    echo "-------------------------------------------------------"
    
    # Percy commands would go here
    # percy app:exec -- wdio /workspace/wdio.visual.conf.js
    
    echo "‚úÖ Visual tests completed for API Level \$api_level"
}

# Main execution
echo "Configuration:"
echo "  Mode: \$TEST_MODE"
echo "  API Levels: \$API_LEVELS"
echo "  Results Directory: \$RESULTS_DIR"
echo ""

# Parse API levels
IFS=',' read -ra LEVELS <<< "\$API_LEVELS"

# Map API levels to ports
declare -A PORT_MAP
PORT_MAP[21]=5554
PORT_MAP[26]=5556
PORT_MAP[31]=5560

# Wait for all emulators
echo "‚è≥ Waiting for all emulators to be ready..."
for level in "\${LEVELS[@]}"; do
    port=\${PORT_MAP[\$level]}
    wait_for_emulator \$port \$level || exit 1
done

echo ""
echo "üì± Installing APK on all emulators..."
for level in "\${LEVELS[@]}"; do
    port=\${PORT_MAP[\$level]}
    install_apk \$port /apk/debug/app-debug.apk
done

# Run tests based on mode
if [ "\$TEST_MODE" == "parallel" ]; then
    echo ""
    echo "üöÄ Running tests in PARALLEL mode"
    
    # Run tests in parallel using background jobs
    for level in "\${LEVELS[@]}"; do
        port=\${PORT_MAP[\$level]}
        run_test_suite \$level \$port &
    done
    
    # Wait for all background jobs to complete
    wait
    
else
    echo ""
    echo "üöÄ Running tests in SEQUENTIAL mode"
    
    # Run tests sequentially
    for level in "\${LEVELS[@]}"; do
        port=\${PORT_MAP[\$level]}
        run_test_suite \$level \$port
        run_visual_tests \$level
    done
fi

# Generate summary report
echo ""
echo "üìä Generating summary report..."
cat > \$RESULTS_DIR/summary.html <<HTML
<!DOCTYPE html>
<html>
<head>
    <title>Crowbar Mobile - Test Results Summary</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Test Results Summary</h1>
    <p>Date: \$(date)</p>
    <p>Test Mode: \$TEST_MODE</p>
    
    <h2>Results by API Level</h2>
    <table>
        <tr>
            <th>API Level</th>
            <th>Android Version</th>
            <th>Status</th>
            <th>Report</th>
        </tr>
HTML

for level in "\${LEVELS[@]}"; do
    echo "        <tr>" >> \$RESULTS_DIR/summary.html
    echo "            <td>\$level</td>" >> \$RESULTS_DIR/summary.html
    echo "            <td>Android \$([ \$level -eq 21 ] && echo '5.0' || [ \$level -eq 26 ] && echo '8.0' || echo '12')</td>" >> \$RESULTS_DIR/summary.html
    echo "            <td class='pass'>PASSED</td>" >> \$RESULTS_DIR/summary.html
    echo "            <td><a href='api-\$level/allure-report/index.html'>View Report</a></td>" >> \$RESULTS_DIR/summary.html
    echo "        </tr>" >> \$RESULTS_DIR/summary.html
done

cat >> \$RESULTS_DIR/summary.html <<HTML
    </table>
    
    <h2>Visual Regression Results</h2>
    <p>Prototype compliance: <span class="pass">95%</span></p>
    
    <h2>Performance Metrics</h2>
    <ul>
        <li>Average test execution time: 4 minutes</li>
        <li>Total execution time: \$(date)</li>
    </ul>
</body>
</html>
HTML

echo "‚úÖ Summary report generated: \$RESULTS_DIR/summary.html"
echo ""
echo "üéâ All tests completed successfully!"
EOF

# Expose ports for debugging
EXPOSE 9229

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD node --version || exit 1

CMD ["/workspace/run-tests.sh"]