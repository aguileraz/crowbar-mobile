# Makefile for Docker-based testing
.PHONY: help build test test-single test-parallel test-api21 test-api26 test-api31 clean logs report

# Default target
help:
	@echo "Crowbar Mobile - Docker Testing Commands"
	@echo "======================================="
	@echo ""
	@echo "Available targets:"
	@echo "  make build          - Build all Docker images"
	@echo "  make test           - Run all tests sequentially"
	@echo "  make test-parallel  - Run all tests in parallel"
	@echo "  make test-api21     - Test on Android API 21 only"
	@echo "  make test-api26     - Test on Android API 26 only"
	@echo "  make test-api31     - Test on Android API 31 only"
	@echo "  make clean          - Stop and remove all containers"
	@echo "  make logs           - Show container logs"
	@echo "  make report         - Open test report in browser"
	@echo ""
	@echo "Advanced usage:"
	@echo "  make test-debug     - Run tests with debug output"
	@echo "  make shell-android  - Open shell in Android container"
	@echo "  make shell-runner   - Open shell in test runner"

# Build Docker images
build:
	@echo "ğŸ—ï¸  Building Docker images..."
	docker-compose build

# Run all tests sequentially
test:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh all

# Run all tests in parallel
test-parallel:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh parallel

# Test specific API levels
test-api21:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh single 21

test-api26:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh single 26

test-api31:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh single 31

# Run tests with debug output
test-debug:
	@echo "ğŸ› Running tests in debug mode..."
	docker-compose run --rm \
		-e DEBUG=true \
		-e LOG_LEVEL=debug \
		test-runner

# Clean up containers
clean:
	@echo "ğŸ§¹ Cleaning up Docker containers..."
	docker-compose down -v
	rm -rf test-results-docker test-reports-docker

# Show logs
logs:
	docker-compose logs -f

# Open test report
report:
	@if [ -f "test-reports-docker/allure-report/index.html" ]; then \
		echo "ğŸ“Š Opening test report..."; \
		open test-reports-docker/allure-report/index.html || \
		xdg-open test-reports-docker/allure-report/index.html || \
		echo "Please open: test-reports-docker/allure-report/index.html"; \
	else \
		echo "âŒ No test report found. Run tests first."; \
	fi

# Interactive shells
shell-android:
	docker-compose run --rm android-31 /bin/bash

shell-runner:
	docker-compose run --rm test-runner /bin/bash

# Quick test (API 31 only)
quick-test: test-api31

# Full CI/CD test suite
ci-test:
	@echo "ğŸš€ Running CI/CD test suite..."
	make build
	make test-parallel
	@echo "âœ… CI/CD tests complete"