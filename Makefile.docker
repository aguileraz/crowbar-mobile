# Makefile for Docker-based testing
.PHONY: help build test test-single test-parallel test-api21 test-api26 test-api31 clean logs report

# Default target
help:
	@echo "Crowbar Mobile - Docker Testing Commands"
	@echo "======================================="
	@echo ""
	@echo "Available targets:"
	@echo "  make build          - Build all Docker images"
	@echo "  make test           - Run all tests sequentially"
	@echo "  make test-parallel  - Run all tests in parallel"
	@echo "  make test-api21     - Test on Android API 21 only"
	@echo "  make test-api26     - Test on Android API 26 only"
	@echo "  make test-api31     - Test on Android API 31 only"
	@echo "  make clean          - Stop and remove all containers"
	@echo "  make logs           - Show container logs"
	@echo "  make report         - Generate and open test dashboard"
	@echo "  make dashboard      - Generate interactive dashboard"
	@echo "  make test-with-dashboard - Run tests and generate dashboard"
	@echo ""
	@echo "Advanced usage:"
	@echo "  make test-debug     - Run tests with debug output"
	@echo "  make shell-android  - Open shell in Android container"
	@echo "  make shell-runner   - Open shell in test runner"

# Build Docker images
build:
	@echo "ğŸ—ï¸  Building Docker images..."
	@echo "ğŸ“¦ Building Android base image first..."
	docker compose -f docker-compose.android.yml build android-base
	@echo "ğŸ“¦ Building specific Android API images..."
	docker compose -f docker-compose.android.yml build android-api-21 android-api-26 android-api-31
	@echo "ğŸ“¦ Building Appium and test runner..."
	docker compose -f docker-compose.android.yml build appium-server test-runner

# Run all tests sequentially
test:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh all

# Run all tests in parallel
test-parallel:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh parallel

# Test specific API levels
test-api21:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh single 21

test-api26:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh single 26

test-api31:
	@chmod +x scripts/test-docker.sh
	./scripts/test-docker.sh single 31

# Run tests with debug output
test-debug:
	@echo "ğŸ› Running tests in debug mode..."
	docker compose -f docker-compose.android.yml run --rm \
		-e DEBUG=true \
		-e LOG_LEVEL=debug \
		test-runner

# Clean up containers
clean:
	@echo "ğŸ§¹ Cleaning up Docker containers..."
	docker compose -f docker-compose.android.yml down -v
	rm -rf test-results-docker test-reports-docker

# Show logs
logs:
	docker compose -f docker-compose.android.yml logs -f

# Generate test reports and dashboard
report:
	@echo "ğŸ“Š Generating comprehensive test report..."
	@mkdir -p test-reports-docker
	@node scripts/generate-test-dashboard.js
	@if [ -f "docker/dashboard/index.html" ]; then \
		echo "âœ… Dashboard generated successfully!"; \
		echo "ğŸŒ Opening dashboard..."; \
		open docker/dashboard/index.html || \
		xdg-open docker/dashboard/index.html || \
		echo "Please open: docker/dashboard/index.html"; \
	else \
		echo "âŒ Failed to generate dashboard"; \
	fi

# Generate interactive dashboard only
dashboard:
	@echo "ğŸ“Š Generating interactive test dashboard..."
	@node scripts/generate-test-dashboard.js
	@echo "âœ… Dashboard available at: docker/dashboard/index.html"
	@echo "ğŸŒ Open in browser: file://$(PWD)/docker/dashboard/index.html"

# Complete test cycle with dashboard
test-with-dashboard: test dashboard
	@echo "ğŸ‰ Complete test cycle finished!"
	@echo "ğŸ“Š View results: file://$(PWD)/docker/dashboard/index.html"

# Interactive shells
shell-android:
	docker compose -f docker-compose.android.yml run --rm android-api-31 /bin/bash

shell-runner:
	docker compose -f docker-compose.android.yml run --rm test-runner /bin/bash

# Quick test (API 31 only)
quick-test: test-api31

# Full CI/CD test suite
ci-test:
	@echo "ğŸš€ Running CI/CD test suite..."
	make build
	make test-parallel
	@echo "âœ… CI/CD tests complete"